"
" ~/.vimrc
"

" load plugins using vim-plug
call plug#begin('~/.vim/pluged')

" Syntax plugins
Plug 'sheerun/vim-polyglot'
Plug 'vim-syntastic/syntastic'

" Color-related plugins
Plug 'altercation/vim-colors-solarized'
Plug 'tomasr/molokai'

" File browser
Plug 'scrooloose/nerdtree', {'on': ['NERDTree', 'NERDTreeToggle', 'NERDTreeFind']}
Plug 'Xuyuanp/nerdtree-git-plugin', {'on': ['NERDTree', 'NERDTreeToggle', 'NERDTreeFind']}

" Outline tags for current file
Plug 'majutsushi/tagbar'

" Toggle using mouse in vim or not
Plug 'nvie/vim-togglemouse'

" code-completion
Plug 'valloric/youcompleteme', {'do': './install.py --clang-completer'}
Plug 'lyuts/vim-rtags'

" Fuzzy finder
Plug 'kien/ctrlp.vim'

" Show buffers as tabs in the tabline
Plug 'ap/vim-buftabline'

" Easy commenting
Plug 'scrooloose/nerdcommenter'

" Per-directory vimrc
Plug 'embear/vim-localvimrc'

" c/c++ plugins
" Plug 'jeaye/color_coded'

" Javascript plugins
Plug 'jelera/vim-javascript-syntax', {'for': 'javascript'}
Plug 'ternjs/tern_for_vim', {'for': 'javascript'}
Plug 'pangloss/vim-javascript', {'for': 'javascript'}
Plug 'maksimr/vim-jsbeautify', {'for': 'javascript'}

" Python related plugins
Plug 'nvie/vim-flake8', {'for': 'python'}

" HTML plugins
Plug 'othree/html5.vim', {'for': 'html'}

" Git plugin
Plug 'tpope/vim-fugitive'

" File-line easy opening plugin
Plug 'bogado/file-line'

" Own configuration plugins
Plug '~/.vim/my-configs'

call plug#end()


" explicitly get out of vi-compatible mode
set nocompatible
" fast terminal buffering
set ttyfast


"----- appearance -----"

colorscheme solarized
set background=dark
let g:solarized_visibility = "high"
let g:solarized_contrast = "high"

" use default syntax highlighting
syntax on
" enable filetype detection
filetype on
" enable filetype-specific indenting
filetype indent on
" enable filetype-specific plugins
filetype plugin on
" show line numbers
set number
" show the 'line,columns' on the bar
set ruler
" show matching brackets.
set showmatch
" show tabline if there are at least two tab pages
set showtabline=2
" set text maximum width to 79 (80 including newline)
set textwidth=79
if exists('+colorcolumn')
  set colorcolumn=80
else
  au BufWinEnter * let w:m2=matchadd('ErrorMsg', '\%>80v.\+', -1)
endif
" Always show the signcolumn, except for tagbar and nerdtree window
autocmd BufRead,BufNewFile * setlocal signcolumn=yes
autocmd FileType tagbar,nerdtree setlocal signcolumn=no


"----- indent ------"
" copy indent from current line when starting a new line
set autoindent
" smart indent when starting a new line
set smartindent
" c-like indent, more strict than smartindent; do not use them simultanously
" set cindent


"----- tabs -----"
" spaces a tab counts for
set tabstop=2
" spaces inserted when hitting tab in Insert mode
set expandtab
" spaces inserted with reindent operations
set shiftwidth=2
" spaces vim uses when hitting Tab in insert mode
"   - if not equal to tabstop, vim will use a combination of tabs and spaces to
"       make up the desired spacing
"   - if equal to tabstop, vimm will insert spaces/tabs for it, depending
"       whether expandtab in on or off
set softtabstop=2


"----- whitespace -----"
" display whitespace characters
set list
" characters to show for tab, trailing whitespace and normal space
" keep the second line around for compatibility problems
set listchars=tab:→\ ,trail:~,nbsp:·
"set listchars=tab:>\ ,trail:~,nbsp:·


"----- search -----"
" highlight the search phrase
set hlsearch
" highlight while typing the search phrase
set incsearch
" do case insensitive matching
set ignorecase
" override ignorecase if pattern contains upper case characters
set smartcase


"----- highlight colors -----"
" change search highlight color
highlight Search cterm=NONE ctermfg=black ctermbg=darkblue
" change TODO highlight color
highlight TODO cterm=NONE ctermfg=red ctermbg=black
" change bracket match highlight color
highlight MatchParen ctermfg=red ctermbg=black
" Reset bad spelling highlight, use only underline
highlight clear SpellBad
highlight SpellBad cterm=underline
" Improve SignColumn color
highlight SignColumn ctermbg=black guibg=darkgrey


"----- menu and status -----"
" always show the status line
set laststatus=2
" turn on command line completion wild style
set wildmenu
" turn on wild mode huge list
set wildmode=list:longest
" show partial commands in last line of screen
set showcmd


"----- miscellaneous -----"
" use smart backspaces over enumerated elements
set backspace=eol,start,indent
" don't wrap lines
set nowrap
" do not save backup files
set nobackup
" do not save swap files
set noswapfile
" remember 1000 commands and history
set history=1000
" set levels of undo
set undolevels=2000
" splitting a window will put the new one below the current one
set splitbelow
" splitting a window will put the new one right to the current one
set splitright
" use mouse with the new sgr protocol (i.e. useful to scroll on big terminals)
if has('mouse_sgr')
  set ttymouse=sgr
endif
" use mouse (=a -> anywhere possible)
set mouse=a
" set timeout between consecutive characters type when entering a command
" sequence
set timeoutlen=500


"----- key mappings -----"
" more efficient command mapping of :
nnoremap ; :
" remap different keys to nothing --- still learning to use vi :)
" noremap <up> <nop>
" noremap <down> <nop>
" noremap <left> <nop>
" noremap <right> <nop>
" map sudo save command
cmap w!! w !sudo tee % >/dev/null
" map line moving up and down; can be used in conjunction with numbers
nnoremap _ @='ddkP'<CR>
nnoremap - @='ddp'<CR>
" surround word by quotes or double quotes; TODO: fix if cursor at end of word
nnoremap <leader>" viw<esc>a"<esc>hbi"<esc>lel
nnoremap <leader>' viw<esc>a'<esc>hbi'<esc>lel
" go to beginning of the current line
nnoremap H ^
" go to the end of the current line
nnoremap L $
" Edit and reload vimrc
map <leader>ev :e $MYVIMRC<cr>
map <leader>sv :so $MYVIMRC<cr>
" Clear search results by pressing Enter
nnoremap <leader><CR> :noh<CR><CR>
" easy search highlighted text (visual highlight and press //)
vnoremap <expr> // 'y/\V'.escape(@",'\').'<CR>'
" Have <esc> leave cmdline-window (I do not use it)
autocmd CmdwinEnter * nnoremap <buffer> <esc> :q\|echo ""<cr>

" set key for paste toogle (when active, the pasted text formatting is not
" modified by any indent feature)
set pastetoggle=<F2>
" keys for NERDTree and Tagbar
nnoremap <leader>n :NERDTree<CR> :NERDTreeFocus<CR>
nnoremap <leader>f :NERDTreeFind<CR>
"fast buffer switch
nnoremap <C-J> :bprev<CR>
nnoremap <C-K> :bnext<CR>
" switch buffers without save
set hidden

"----- function to remove trailing whitespace -----"
fun! <SID>StripTrailingWhitespaces()
  let L = line(".")
  let C = col(".")
  %s/\s\+$//e
  call cursor(L, C)
endfun
"---- call above function on each write;
" Internet says it's unsafe if you edit binary files
" XXX: call it on exit for file, not on each write
" FIXME: strip trailing whitespace only on edited lines
" autocmd BufWrite  * :call <SID>StripTrailingWhitespaces()

" Set specific syntax (objective-c vs octave problem)
"augroup filetypedetect
"  au! BufRead, BufNewFile *.m,*.oct set filetype=octave
"augroup END

"-- cscope --"
set nocscopeverbose " suppress 'duplicate connection' error
function! LoadCscope()
  let db = findfile("cscope.out", ".;")
  if (!empty(db))
    let path = strpart(db, 0, match(db, "/cscope.out$"))
    set nocscopeverbose " suppress 'duplicate connection' error
    exe "cs add " . db . " " . path
    set cscopeverbose
  endif
endfunction
autocmd BufEnter /* call LoadCscope()

"-- tagbar --"
" Save screen space
let g:tagbar_compact = 1
" set indentation for folds
let g:tagbar_indent = 1
" use single-click to jump to tag
let g:tagbar_singleclick = 1
" show current tag if folded
let g:tagbar_autoshowtag = 1
highlight TagbarSignature ctermbg=black guibg=darkgrey


"-- NERDTree --"
" close NERDTree if it's the last window
autocmd bufenter * if (winnr("$") == 1 && exists("b:NERDTree") && b:NERDTree.isTabTree()) | q | endif
" Remove extra lines
let NERDTreeMinimalUI = 1

"-- YouCompleteMe --"
"let g:ycm_autoclose_preview_window_after_insertion = 1
"let g:ycm_always_populate_location_list = 1
"let g:ycm_error_symbol = '⇨'
"map <leader>g  :YcmCompleter GoToDefinitionElseDeclaration<CR>
"map <leader>f  :YcmCompleter FixIt<CR>


"-- syntastic --"
"set statusline+=%#warningmsg#
"set statusline+=%{SyntasticStatuslineFlag()}
"set statusline+=%*
let g:syntastic_mode_map = { 'mode': 'passive', 'active_filetypes': [],'passive_filetypes': [] }
"let g:syntastic_always_populate_loc_list = 1
"let g:syntastic_auto_loc_list = 1
"let g:syntastic_check_on_open = 1
"let g:syntastic_check_on_wq = 0
"let g:syntastic_python_checkers = ['pycodestyle', 'pep8', 'python']

"-- buftabline --"
let g:buftabline_plug_max=20
