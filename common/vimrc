"
" ~/.vimrc
"

" load plugins using vim-plug
call plug#begin('~/.vim/pluged')

" Syntax plugins
Plug 'sheerun/vim-polyglot'
" Keep commented out until a stable configuration is in place.
" Plug 'vim-syntastic/syntastic'
Plug 'trapd00r/vim-ansicolors' " recognize ANSI color esape sequences
Plug 'w0rp/ale'

" Color-related plugins
Plug 'altercation/vim-colors-solarized'
Plug 'dracula/vim', { 'as': 'dracula' }
Plug 'tomasr/molokai'
Plug 'morhetz/gruvbox'
Plug 'arcticicestudio/nord-vim'

" File browser
" All lazy load is commented out for the settings at the end of the file.
Plug 'scrooloose/nerdtree' ", {'on': ['NERDTree', 'NERDTreeToggle', 'NERDTreeFind']}
Plug 'Xuyuanp/nerdtree-git-plugin' ", {'on': ['NERDTree', 'NERDTreeToggle', 'NERDTreeFind']}
Plug 'PhilRunninger/nerdtree-buffer-ops'

" Outline tags for current file
Plug 'majutsushi/tagbar'

" Show open buffers in a tab line
Plug 'ap/vim-buftabline'

" Toggle using mouse in vim or not
Plug 'nvie/vim-togglemouse'

" code-completion
" Keep commented out until a stable configuration is in place.
" Plug 'valloric/youcompleteme', {'do': './install.py --clang-completer'}

" Fuzzy finder
Plug 'yggdroot/leaderf', {'do': './install.sh'}

" Easy commenting
Plug 'scrooloose/nerdcommenter'

" Per-directory vimrc
Plug 'embear/vim-localvimrc'

" c/c++ plugins
" Plug 'jeaye/color_coded'
" TODO: configure flags for the one below.
Plug 'octol/vim-cpp-enhanced-highlight', {'for': 'cpp'}
" Plug 'lyuts/vim-rtags', {'for': 'cpp'}

" CMake improved syntax
Plug 'pboettch/vim-cmake-syntax', {'for': 'cmake'}

" Xcconfig syntax
Plug 'keith/xcconfig.vim', {'for': 'xcconfig'}

" Xcode project file syntax
Plug 'cfdrake/vim-pbxproj', {'for': 'pbxproj'}

" SWIG file syntax
" Plug 'vim-scripts/swig'

" Javascript plugins
Plug 'jelera/vim-javascript-syntax', {'for': 'javascript'}
Plug 'ternjs/tern_for_vim', {'for': 'javascript'}
Plug 'pangloss/vim-javascript', {'for': 'javascript'}
Plug 'maksimr/vim-jsbeautify', {'for': 'javascript'}

" Python related plugins
" Keep commented out until a stable configuration is in place.
" Plug 'davidhalter/jedi-vim', {'for': 'python'}
Plug 'nvie/vim-flake8', {'for': 'python'}

" HTML plugins
Plug 'othree/html5.vim', {'for': 'html'}

" Git plugins
Plug 'tpope/vim-fugitive'
Plug 'airblade/vim-gitgutter'

" File-line easy opening plugin
Plug 'bogado/file-line'

" LSP
" Plug 'prabirshrestha/asyncomplete.vim'
" Plug 'prabirshrestha/async.vim'
" Plug 'prabirshrestha/vim-lsp'
" Plug 'prabirshrestha/asyncomplete-lsp.vim'

" Own configuration plugins
Plug '~/.vim/my-configs'

call plug#end()


" explicitly get out of vi-compatible mode
set nocompatible
" fast terminal buffering
set ttyfast


"----- appearance -----"

set termguicolors

try
  " Use same background and differentiate only using colors in diff mode
  let g:nord_uniform_diff_background = 1
  " Enables background for the line number of the current line.
  let g:nord_cursor_line_number_background = 1
  colorscheme nord
catch
try
  colorscheme solarized
  let g:solarized_visibility = "high"
  let g:solarized_contrast = "high"
catch
try
  colorscheme dracula
catch
endtry
endtry
endtry

set background=dark

" Improve visual performance by not redrawing the screen when executing some commands
set lazyredraw
" use default syntax highlighting
syntax on
" enable filetype detection
filetype on
" enable filetype-specific indenting
filetype indent on
" enable filetype-specific plugins
filetype plugin on
" show line numbers...
set number
" ... except when on quickfix
autocmd FileType qf setlocal nonumber
" show the 'line,columns' on the bar
set ruler
" highlight the cursor line; using this + vertical splits is slow, keep commented out for now
"set cursorline
" show matching brackets
set showmatch
" show tabline if there are at least two tab pages
set showtabline=1
" set text maximum width to 99 (100 including newline) - except when on quickfix
set textwidth=99
if exists('+colorcolumn')
  set colorcolumn=100
  autocmd FileType qf setlocal colorcolumn=
else
  autocmd BufWinEnter * let w:m2=matchadd('ErrorMsg', '\%>99v.\+', -1)
  " TODO remove matchadd on quickfix window for older versions of vim
endif
" Always show the signcolumn, except for plugins configured below
autocmd BufRead,BufNewFile * setlocal signcolumn=yes


"----- indent ------"
" copy indent from current line when starting a new line
set autoindent
" smart indent when starting a new line
set smartindent
" c-like indent, more strict than smartindent; do not use them simultanously
"set cindent


"----- tabs -----"
" spaces a tab counts for
set tabstop=2
" spaces inserted when hitting tab in Insert mode
set expandtab
" spaces inserted with reindent operations
set shiftwidth=2
" spaces vim uses when hitting Tab in insert mode
"   - if not equal to tabstop, vim will use a combination of tabs and spaces to
"       make up the desired spacing
"   - if equal to tabstop, vimm will insert spaces/tabs for it, depending
"       whether expandtab in on or off
set softtabstop=2


"----- whitespace -----"
" display whitespace characters
set list
" characters to show for tab, trailing whitespace and normal space
try
  set listchars=tab:→\ ,trail:~,nbsp:·
catch
  set listchars=tab:>\ ,trail:_,nbsp:~
endtry
set showbreak=\\   " the spaces are needed


"----- search -----"
" highlight the search phrase
set hlsearch
" highlight while typing the search phrase
set incsearch
" do case insensitive matching
set ignorecase
" override ignorecase if pattern contains upper case characters
set smartcase


"----- highlight colors -----"
" change search highlight color
highlight Search cterm=NONE ctermfg=black ctermbg=darkblue
" change TODO highlight color
highlight TODO cterm=NONE ctermfg=red ctermbg=black
" change bracket match highlight color
highlight MatchParen ctermfg=red ctermbg=black
" Reset bad spelling highlight, use only underline
highlight clear SpellBad
highlight SpellBad cterm=underline
" Improve SignColumn color
highlight SignColumn ctermbg=black guibg=darkgrey
highlight SpecialKey cterm=NONE ctermfg=grey


"----- menu and status -----"
" always show the status line
set laststatus=2
" turn on command line completion wild style
set wildmenu
" turn on wild mode huge list
set wildmode=list:longest
" show partial commands in last line of screen
set showcmd


"----- miscellaneous -----"
" use smart backspaces over enumerated elements
set backspace=eol,start,indent
" don't wrap lines
set nowrap
" do not save backup files
set nobackup
" do not save swap files
set noswapfile
" remember 1000 commands and history
set history=1000
" set levels of undo
set undolevels=2000
" splitting a window will put the new one below the current one
set splitbelow
" splitting a window will put the new one right to the current one
set splitright
" use mouse with the new sgr protocol (i.e. useful to scroll on big terminals)
if has('mouse_sgr')
  set ttymouse=sgr
endif
" use mouse (=a -> anywhere possible)
set mouse=a
" set timeout between consecutive characters type when entering a command
" sequence
set timeoutlen=500


"----- key mappings -----"
" map space to leader
nnoremap <SPACE> <Nop>
let mapleader = "\<Space>"
" more efficient command mapping of :
nnoremap ; :
" remap different keys to nothing --- still learning to use vi :)
noremap <up> <nop>
noremap <down> <nop>
noremap <left> <nop>
noremap <right> <nop>
" map sudo save command
cmap w!! w !sudo tee % >/dev/null
" map line moving up and down; can be used in conjunction with numbers
nnoremap - @='ddp'<CR>
nnoremap _ @='ddkP'<CR>
" surround word by quotes or double quotes
nnoremap <leader>" viw<esc>a"<esc>hbi"<esc>lel
nnoremap <leader>' viw<esc>a'<esc>hbi'<esc>lel
" go to beginning of the current line
nnoremap H ^
" go to the end of the current line
nnoremap L $
" Edit and reload vimrc
map <leader>ev :e $MYVIMRC<cr>
map <leader>sv :so $MYVIMRC<cr>
" Clear search results by pressing Enter
nnoremap <leader><CR> :noh<CR><CR>
" easy search highlighted text (visual highlight and press //)
vnoremap <expr> // 'y/\V'.escape(@",'\').'<CR>'
" Have <esc> leave cmdline-window (I do not use it)
autocmd CmdwinEnter * nnoremap <buffer> <esc> :q\|echo ""<cr>
"fast buffer switch
nnoremap <C-J> :bprev<CR>
nnoremap <C-K> :bnext<CR>
" switch buffers without save
set hidden

" set key for paste toogle (when active, the pasted text formatting is not
" modified by any indent feature)
set pastetoggle=<F2>

"----- function to remove trailing whitespace -----"
fun! <SID>StripTrailingWhitespaces()
  let L = line(".")
  let C = col(".")
  %s/\s\+$//e
  call cursor(L, C)
endfun
"---- call above function on each write;
" Internet says it's unsafe if you edit binary files
" XXX: call it on exit for file, not on each write
" FIXME: strip trailing whitespace only on edited lines
" autocmd BufWrite  * :call <SID>StripTrailingWhitespaces()
" Set specific syntax

" objective-c vs octave problem
augroup filetypedetect
  " au! BufRead, BufNewFile *.m,*.oct set filetype=octave
  au! BufRead,BufNewFile,BufRead *.m set filetype=objc
  au! BufRead,BufNewFile,BufRead *.mm set filetype=objcpp
augroup END
augroup filetypedetect
  au! BufRead, BufNewFile *.xcconfig set filetype=xcconfig
augroup END

"-- cscope --"
"set nocscopeverbose " suppress 'duplicate connection' error
"function! LoadCscope()
"  let db = findfile("cscope.out", ".;")
"  if (!empty(db))
"    let path = strpart(db, 0, match(db, "/cscope.out$"))
"    set nocscopeverbose " suppress 'duplicate connection' error
"    exe "cs add " . db . " " . path
"    set cscopeverbose
"  endif
"endfunction
"autocmd BufEnter /* call LoadCscope()



"----- plugin settings -----"

if &runtimepath =~ '/tagbar/'
  " Save screen space
  let g:tagbar_compact = 1
  " set indentation for folds
  let g:tagbar_indent = 1
  " use single-click to jump to tag
  let g:tagbar_singleclick = 1
  " show current tag if folded
  let g:tagbar_autoshowtag = 1
  highlight TagbarSignature ctermbg=black guibg=darkgrey
  " Remove sign column
  autocmd FileType tagbar setlocal signcolumn=no
  " Mappings
  nnoremap <leader>t :TagbarToggle<CR>
endif

if &runtimepath =~ '/nerdtree/'
  " close NERDTree if it's the last window
  autocmd bufenter * if (winnr("$") == 1 && exists("b:NERDTree") && b:NERDTree.isTabTree()) | q | endif
  " Remove extra lines
  let NERDTreeMinimalUI = 1
  " Remove signcolumn
  autocmd FileType nerdree setlocal signcolumn=no
  " Mappings
  nnoremap <leader>nn :NERDTreeToggle<CR>
  nnoremap <leader>nf :NERDTreeFind<CR>
endif

if &runtimepath =~ '/syntastic/'
  set statusline+=%#warningmsg#
  set statusline+=%{SyntasticStatuslineFlag()}
  set statusline+=%*
  let g:syntastic_mode_map = { 'mode': 'pasive', 'active_filetypes': [] ,'passive_filetypes': [] }
  let g:syntastic_always_populate_loc_list = 1
  let g:syntastic_auto_loc_list = 1
  let g:syntastic_check_on_open = 1
  let g:syntastic_check_on_wq = 0
  let g:syntastic_python_checkers = ['pycodestyle', 'pep8', 'python']
endif

if &runtimepath =~ '/youcompleteme/'
  " Close preview window after accepting the offered completion.
  let g:ycm_autoclose_preview_window_after_insertion = 1
  " TODO: check if this is needed if syntastic is not enabled
  let g:ycm_always_populate_location_list = 1
  " Symbol for errors. If not, it defaults to g:syntastic_error_symbol.
  let g:ycm_error_symbol = '⇨'
  " Mappings
  map <leader>g  :YcmCompleter GoToDefinitionElseDeclaration<CR>
  map <leader>f  :YcmCompleter FixIt<CR>
endif

if &runtimepath =~ '/vim-rtags/'
  " Use QuickFix window instead of the location list
  let g:rtagsUseLocationList = 0
endif

if &runtimepath =~ '/vim-localvimrc/'
  " Don't ask for sourcing a local vimrc file for the same vim session.
  let g:localvimrc_ask=0
endif

if &runtimepath =~ '/ale/'
  " Set various linters
  let g:ale_linters = {
    \ 'python': ['pycodestyle'],
    \ 'cpp': [],
    \ 'sh': ['shellcheck'],
    \ 'zsh': ['shellcheck']
    \ }
  " Automatically parse compile_commands.json.
  let g:ale_c_parse_compile_commands = 1
endif

if &runtimepath =~ '/vim-lsp/'
  if executable('ccls')
    au User lsp_setup call lsp#register_server({
          \ 'name': 'ccls',
          \ 'cmd': {server_info->['ccls']},
          \ 'root_uri': {
          \   server_info->lsp#utils#path_to_uri(
          \     lsp#utils#find_nearest_parent_file_directory(
          \       lsp#utils#get_buffer_path(), 'compile_commands.json'))
          \ },
          \ 'initialization_options': {
          \   'cache': {'directory': '/tmp/ccls/cache'},
          \   'diagnostics': {'onChange': 2000}
          \ },
          \ 'whitelist': ['h', 'c', 'cpp', 'objc', 'objcpp', 'cc'],
          \ })
  endif

  " Some LSP jump shortcuts.
  nnoremap <silent> <leader>d :LspDefinition<cr>
  nnoremap <silent> <leader>r :LspReferences<cr>
  nnoremap <silent> <leader>R :LspRename<cr>
  nnoremap <silent> <leader>a :LspWorkspaceSymbol<cr>
  nnoremap <silent> <leader>l :LspDocumentSymbol<cr>

  " TODO: Consider enabling diagnostics.
  let g:lsp_diagnostics_enabled = 0

endif

if &runtimepath =~ '/asynccomplete/'
  " Autocomplete with Tab
  inoremap <expr> <Tab>   pumvisible() ? "\<C-n>" : "\<Tab>"
  inoremap <expr> <S-Tab> pumvisible() ? "\<C-p>" : "\<S-Tab>"
  inoremap <expr> <cr>    pumvisible() ? "\<C-y>" : "\<cr>"

  " Disable preview window
  set completeopt+=preview

  " Autoclose preview window
  autocmd! CompleteDone * if pumvisible() == 0 | pclose | endif
endif
