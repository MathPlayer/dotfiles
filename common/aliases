#
# Rule of thumb for the Apple ecosystem: most of the default command-line tools are old/outdated,
# try switching to GNU alternatives if they are found.
#


# Source user's comnands file for helper functions.
. "${HOME}/.bin/commands.sh"

### dircolors
alias_dircolors() {
  EXEC=""

  # Check if dircolors is available and switch to it.
  command_exists "dircolors" && EXEC="$(get_absolute_path dircolors)"

  # Check if gdircolors is available and switch to it.
  command_exists "gdircolors" && EXEC="$(get_absolute_path gdircolors)"

  # Load dircolors if existing.
  if [ -x "${EXEC}" ] && [ -r "${HOME}/.dircolors" ]; then
      eval "$(${EXEC} -b "${HOME}/.dircolors")" || eval "$(${EXEC} -b)"
    # Failsafe alias for dircolors.
    alias dircolors="${EXEC}"
  fi
}
alias_dircolors
unset alias_dircolors


### rm
command_exists "grm" && alias rm="$(get_absolute_path grm)"


### tar
command_exists "gtar" && alias tar="$(get_absolute_path gtar)"


### sed
command_exists "gsed" && alias sed="$(get_absolute_path gsed)"


### find
command_exists "gfind" && alias find="$(get_absolute_path gfind)"


### ls
alias_ls() {
  EXEC="$(get_absolute_path ls)"
  FLAG_COLOR=""
  FLAG_GROUP_DIRECTORIES_FIRST=""
  FLAG_HUMAN_SIZE=""
  FLAG_INDICATOR=""

  # Check if gls is available and switch to it.
  command_exists "gls" && EXEC="$(get_absolute_path gls)"

  # Show colored output.
  if "${EXEC}" --color=auto >/dev/null 2>&1; then
    FLAG_COLOR="--color=auto"
  elif "${EXEC}" -G >/dev/null 2>&1; then
    FLAG_COLOR="-G"
  fi

  # Show size in human-readable format.
  if "${EXEC}" -lh >/dev/null 2>&1; then
    FLAG_HUMAN_SIZE="-h"
  fi

  # Add specific indicator after directory/socket/link/...
  if "${EXEC}" -F >/dev/null 2>&1; then
    FLAG_INDICATOR="-F"
  fi

  # Try to group directories first.
  if "${EXEC}" --group-directories-first >/dev/null 2>&1; then
    FLAG_GROUP_DIRECTORIES_FIRST="--group-directories-first"
  fi

  # Set aliases.
  LS_COMMAND="${EXEC} ${FLAG_COLOR} ${FLAG_INDICATOR} ${FLAG_HUMAN_SIZE} ${FLAG_GROUP_DIRECTORIES_FIRST}"
  alias ls="${LS_COMMAND}"
  alias sl="${LS_COMMAND}"
  alias LS="${LS_COMMAND}"
  alias l="${LS_COMMAND} -l"
  alias ll="${LS_COMMAND} -l"
  alias la="${LS_COMMAND} -A"
  alias la="${LS_COMMAND} -A"
  alias lla="${LS_COMMAND} -lA"
}
alias_ls
unset alias_ls


### Various others

# Add automatic color output for some tools.
for TOOL in "grep" "fgrep" "egrep" "diff"; do
  command_exists ${TOOL} --color=auto && alias ${TOOL}="${TOOL} --color=auto"
done

# Default to human readable figures.
alias df='df -h'
alias du='du -h'

# List only user's processes.
alias myps='ps axo user,tty,ppid,pid,command | grep -vE "grep|ps axo" | grep -E "(USER\s*PPID)|${USER}"'
alias mypsa='ps aux | grep -vE "grep|ps aux" | grep -E "(USER\s*PID)|${USER}"'

# Exit less if the output is small enough for only one screen
alias less='less -F'

# Force showing all output using tail
alias ftail='tail -f -n+1'

# SSH with logging
alias logssh='ssh > >(tee ssh-$(date +"%Y-%m-%d-%H-%M").out) 2> >(tee ssh-$(date +"%Y-%m-%d-%H-%M").err >&2)'
